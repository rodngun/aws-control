#!/bin/bash

# RodNGun Cloud Management Script
# Unified script for managing AWS infrastructure deployments
# Usage: ./rodngun-cloud [deploy|decommission|cost] [lightsail|containers]

set -e

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Configuration
REGION="${AWS_REGION:-us-east-1}"
PROJECT_NAME="rodngun"

# Function to display usage
show_usage() {
    echo ""
    echo -e "${BOLD}RodNGun Cloud Infrastructure Manager${NC}"
    echo "======================================"
    echo ""
    echo "Usage: $0 <command> [options]"
    echo ""
    echo "Commands:"
    echo "  deploy lightsail      Deploy API using AWS Lightsail (VM-based, $10/month)"
    echo "  deploy containers     Deploy API using AWS App Runner (containerized, $20-40/month)"
    echo "  deploy-data          Deploy latest MongoDB data to Lightsail instance"
    echo "  backup-data          Create BSON backup from local data files"
    echo "  decommission lightsail    Destroy all Lightsail resources"
    echo "  decommission containers   Destroy all container resources"
    echo "  cost                 Analyze current AWS costs"
    echo "  status              Show deployment status"
    echo "  clean                Remove ALL AWS resources (DANGEROUS!)"
    echo ""
    echo "Examples:"
    echo "  $0 deploy lightsail"
    echo "  $0 decommission lightsail"
    echo "  $0 cost"
    echo "  $0 clean   # Remove everything"
    echo ""
    exit 1
}

# Function to check prerequisites
check_prerequisites() {
    echo -e "${YELLOW}Checking prerequisites...${NC}"
    
    # Check AWS CLI
    if ! command -v aws &> /dev/null; then
        echo -e "${RED}ERROR: AWS CLI is not installed${NC}"
        echo "Please install AWS CLI: https://aws.amazon.com/cli/"
        exit 1
    fi
    
    # Check AWS credentials
    if ! aws sts get-caller-identity &> /dev/null; then
        echo -e "${RED}ERROR: AWS credentials not configured${NC}"
        echo "Please run: aws configure"
        exit 1
    fi
    
    # Check Docker for container deployments
    if [[ "$1" == "containers" ]]; then
        if ! command -v docker &> /dev/null; then
            echo -e "${RED}ERROR: Docker is not installed${NC}"
            echo "Please install Docker: https://www.docker.com/get-started"
            exit 1
        fi
    fi
    
    echo -e "${GREEN}Prerequisites check passed${NC}"
}

# Function to deploy Lightsail
deploy_lightsail() {
    echo ""
    echo -e "${BOLD}Deploying Lightsail Infrastructure${NC}"
    echo "======================================"
    echo "Cost: ~$10-12/month"
    echo "Architecture: Single VM with local MongoDB"
    echo ""
    
    read -p "Continue with Lightsail deployment? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Deployment cancelled."
        exit 0
    fi
    
    check_prerequisites
    
    # Execute Lightsail deployment
    if [ -f "$SCRIPT_DIR/lightsail/deploy.sh" ]; then
        bash "$SCRIPT_DIR/lightsail/deploy.sh"
    else
        echo -e "${RED}ERROR: Lightsail deployment script not found${NC}"
        echo "Creating deployment script..."
        create_lightsail_scripts
        bash "$SCRIPT_DIR/lightsail/deploy.sh"
    fi
}

# Function to deploy containers
deploy_containers() {
    echo ""
    echo -e "${BOLD}Deploying Container Infrastructure${NC}"
    echo "======================================"
    echo ""
    echo "Select container platform:"
    echo "  1) AWS App Runner (Recommended - $20-40/month)"
    echo "  2) AWS Fargate/ECS (Production - $35-50/month)"
    echo ""
    read -p "Enter choice (1 or 2): " choice
    
    case $choice in
        1)
            echo ""
            echo "Note: App Runner requires MongoDB Atlas ($60/month)"
            read -p "Do you have MongoDB Atlas configured? (y/n): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo ""
                echo "Please set up MongoDB Atlas first:"
                echo "1. Go to https://cloud.mongodb.com"
                echo "2. Create an M10 cluster"
                echo "3. Get your connection string"
                echo "4. Export it: export MONGODB_URI='your-connection-string'"
                exit 1
            fi
            
            check_prerequisites containers
            
            if [ -f "$SCRIPT_DIR/containers/deploy_apprunner.sh" ]; then
                bash "$SCRIPT_DIR/containers/deploy_apprunner.sh"
            else
                echo -e "${RED}ERROR: App Runner deployment script not found${NC}"
                echo "Creating deployment script..."
                create_container_scripts
                bash "$SCRIPT_DIR/containers/deploy_apprunner.sh"
            fi
            ;;
        2)
            echo ""
            echo "Note: Fargate requires MongoDB Atlas ($60/month)"
            read -p "Do you have MongoDB Atlas configured? (y/n): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo ""
                echo "Please set up MongoDB Atlas first:"
                echo "1. Go to https://cloud.mongodb.com"
                echo "2. Create an M10 cluster"
                echo "3. Get your connection string"
                echo "4. Export it: export MONGODB_URI='your-connection-string'"
                exit 1
            fi
            
            check_prerequisites containers
            
            if [ -f "$SCRIPT_DIR/containers/deploy_fargate.sh" ]; then
                bash "$SCRIPT_DIR/containers/deploy_fargate.sh"
            else
                echo -e "${RED}ERROR: Fargate deployment script not found${NC}"
                echo "Creating deployment script..."
                create_container_scripts
                bash "$SCRIPT_DIR/containers/deploy_fargate.sh"
            fi
            ;;
        *)
            echo -e "${RED}Invalid choice${NC}"
            exit 1
            ;;
    esac
}

# Function to decommission Lightsail
decommission_lightsail() {
    echo ""
    echo -e "${BOLD}${RED}Decommissioning Lightsail Infrastructure${NC}"
    echo "======================================"
    echo ""
    echo -e "${YELLOW}WARNING: This will destroy all Lightsail resources!${NC}"
    echo "Resources to be deleted:"
    echo "  - Lightsail instance: rodngun-api"
    echo "  - Static IP: rodngun-api-ip"
    echo "  - All snapshots and backups"
    echo ""
    read -p "Are you SURE you want to destroy all Lightsail resources? Type 'yes' to confirm: " confirm
    
    if [ "$confirm" != "yes" ]; then
        echo "Decommission cancelled."
        exit 0
    fi
    
    echo ""
    echo -e "${YELLOW}Starting decommission process...${NC}"
    
    # Instance name and resources
    INSTANCE_NAME="rodngun-api"
    STATIC_IP_NAME="rodngun-api-ip"
    KEY_PAIR_NAME="rodngun-lightsail-key"
    
    # Delete instance
    echo "Deleting Lightsail instance..."
    aws lightsail delete-instance \
        --instance-name $INSTANCE_NAME \
        --region $REGION 2>/dev/null || echo "Instance not found or already deleted"
    
    # Delete static IP
    echo "Releasing static IP..."
    aws lightsail release-static-ip \
        --static-ip-name $STATIC_IP_NAME \
        --region $REGION 2>/dev/null || echo "Static IP not found or already released"
    
    # Delete snapshots
    echo "Deleting instance snapshots..."
    SNAPSHOTS=$(aws lightsail get-instance-snapshots \
        --region $REGION \
        --query "instanceSnapshots[?contains(name, '$INSTANCE_NAME')].name" \
        --output text 2>/dev/null || echo "")
    
    if [ ! -z "$SNAPSHOTS" ]; then
        for snapshot in $SNAPSHOTS; do
            echo "  Deleting snapshot: $snapshot"
            aws lightsail delete-instance-snapshot \
                --instance-snapshot-name $snapshot \
                --region $REGION 2>/dev/null || echo "    Failed to delete $snapshot"
        done
    fi
    
    # Check for orphaned/old SSH key pairs in AWS
    echo "Checking for old SSH key pairs in AWS..."
    ALL_KEY_PAIRS=$(aws lightsail get-key-pairs --region $REGION --query 'keyPairs[].name' --output text 2>/dev/null || echo "")
    
    if [ ! -z "$ALL_KEY_PAIRS" ]; then
        for key_name in $ALL_KEY_PAIRS; do
            # Only delete keys that belong to this project but are no longer in use
            if [[ "$key_name" == "rodngun-lightsail-key"* ]]; then
                # Check if this key is being used by any existing instance
                KEY_IN_USE=$(aws lightsail get-instances \
                    --region $REGION \
                    --query "instances[?keyPairName=='$key_name'].name" \
                    --output text 2>/dev/null || echo "")
                
                if [ -z "$KEY_IN_USE" ]; then
                    echo "  Removing unused key pair: $key_name"
                    aws lightsail delete-key-pair \
                        --key-pair-name $key_name \
                        --region $REGION 2>/dev/null || echo "    Could not delete $key_name"
                    
                    # Also remove corresponding local file if it exists
                    if [ -f ~/.ssh/${key_name}.pem ]; then
                        echo "  Removing local key file: ~/.ssh/${key_name}.pem"
                        rm -f ~/.ssh/${key_name}.pem
                    fi
                    if [ -f ~/.ssh/${key_name}.pem.b64 ]; then
                        rm -f ~/.ssh/${key_name}.pem.b64
                    fi
                else
                    echo "  Keeping active key pair: $key_name (in use by instance: $KEY_IN_USE)"
                fi
            fi
        done
    fi
    
    # Clean up any orphaned local SSH key files (that don't have corresponding AWS keys)
    echo "Cleaning up orphaned local SSH keys..."
    for local_key in ~/.ssh/rodngun-lightsail-*.pem; do
        if [ -f "$local_key" ]; then
            KEY_NAME=$(basename "$local_key" .pem)
            # Check if this key exists in AWS
            AWS_KEY_EXISTS=$(aws lightsail get-key-pair \
                --key-pair-name "$KEY_NAME" \
                --region $REGION 2>/dev/null || echo "")
            
            if [ -z "$AWS_KEY_EXISTS" ]; then
                echo "  Removing orphaned local key: $local_key"
                rm -f "$local_key"
                rm -f "${local_key}.b64" 2>/dev/null || true
            fi
        fi
    done
    
    echo ""
    echo -e "${GREEN}Lightsail decommission complete!${NC}"
    echo "All resources have been removed."
    echo "Old/unused SSH keys have been cleaned up."
    echo ""
    echo "Monthly cost savings: ~$10-12"
}

# Function to decommission containers
decommission_containers() {
    echo ""
    echo -e "${BOLD}${RED}Decommissioning Container Infrastructure${NC}"
    echo "======================================"
    echo ""
    
    # Check what container services exist
    echo -e "${YELLOW}Checking for existing container services...${NC}"
    
    # Check App Runner
    APP_RUNNER_SERVICE=$(aws apprunner list-services \
        --region $REGION \
        --query "ServiceSummaryList[?ServiceName=='rodngun-api'].ServiceArn" \
        --output text 2>/dev/null || echo "")
    
    # Check ECS/Fargate
    ECS_CLUSTER=$(aws ecs describe-clusters \
        --clusters rodngun-cluster \
        --region $REGION \
        --query 'clusters[0].clusterArn' \
        --output text 2>/dev/null || echo "")
    
    if [ -z "$APP_RUNNER_SERVICE" ] && [ -z "$ECS_CLUSTER" ]; then
        echo "No container infrastructure found."
        exit 0
    fi
    
    echo ""
    echo -e "${YELLOW}WARNING: This will destroy all container resources!${NC}"
    echo "Resources to be deleted:"
    
    if [ ! -z "$APP_RUNNER_SERVICE" ]; then
        echo "  - App Runner service: rodngun-api"
    fi
    
    if [ ! -z "$ECS_CLUSTER" ]; then
        echo "  - ECS cluster: rodngun-cluster"
        echo "  - Fargate services and tasks"
        echo "  - Load balancer: rodngun-alb"
        echo "  - Target groups"
        echo "  - VPC and networking (if created)"
    fi
    
    echo "  - ECR repository: rodngun-api"
    echo "  - IAM roles and policies"
    echo ""
    read -p "Are you SURE you want to destroy all container resources? Type 'yes' to confirm: " confirm
    
    if [ "$confirm" != "yes" ]; then
        echo "Decommission cancelled."
        exit 0
    fi
    
    echo ""
    echo -e "${YELLOW}Starting decommission process...${NC}"
    
    # Delete App Runner service
    if [ ! -z "$APP_RUNNER_SERVICE" ] && [ "$APP_RUNNER_SERVICE" != "None" ]; then
        echo "Deleting App Runner service..."
        aws apprunner delete-service \
            --service-arn "$APP_RUNNER_SERVICE" \
            --region $REGION
        echo "Waiting for App Runner deletion (this may take a few minutes)..."
        sleep 30
    fi
    
    # Delete ECS/Fargate resources
    if [ ! -z "$ECS_CLUSTER" ] && [ "$ECS_CLUSTER" != "None" ]; then
        echo "Deleting ECS services..."
        
        # Update service to 0 tasks
        aws ecs update-service \
            --cluster rodngun-cluster \
            --service rodngun-api-service \
            --desired-count 0 \
            --region $REGION 2>/dev/null || echo "Service not found"
        
        # Delete service
        aws ecs delete-service \
            --cluster rodngun-cluster \
            --service rodngun-api-service \
            --force \
            --region $REGION 2>/dev/null || echo "Service already deleted"
        
        # Delete ALB
        ALB_ARN=$(aws elbv2 describe-load-balancers \
            --names rodngun-alb \
            --query 'LoadBalancers[0].LoadBalancerArn' \
            --output text \
            --region $REGION 2>/dev/null || echo "")
        
        if [ ! -z "$ALB_ARN" ] && [ "$ALB_ARN" != "None" ]; then
            echo "Deleting Application Load Balancer..."
            aws elbv2 delete-load-balancer \
                --load-balancer-arn $ALB_ARN \
                --region $REGION 2>/dev/null || echo "ALB already deleted"
        fi
        
        # Delete target group
        TG_ARN=$(aws elbv2 describe-target-groups \
            --names rodngun-tg \
            --query 'TargetGroups[0].TargetGroupArn' \
            --output text \
            --region $REGION 2>/dev/null || echo "")
        
        if [ ! -z "$TG_ARN" ] && [ "$TG_ARN" != "None" ]; then
            echo "Deleting target group..."
            sleep 10  # Wait for ALB deletion
            aws elbv2 delete-target-group \
                --target-group-arn $TG_ARN \
                --region $REGION 2>/dev/null || echo "Target group already deleted"
        fi
        
        # Delete cluster
        echo "Deleting ECS cluster..."
        aws ecs delete-cluster \
            --cluster rodngun-cluster \
            --region $REGION 2>/dev/null || echo "Cluster already deleted"
    fi
    
    # Delete ECR repository
    echo "Deleting ECR repository..."
    aws ecr delete-repository \
        --repository-name rodngun-api \
        --force \
        --region $REGION 2>/dev/null || echo "ECR repository not found"
    
    # Delete VPC (if it was created for containers)
    VPC_ID=$(aws ec2 describe-vpcs \
        --filters "Name=tag:Name,Values=rodngun-vpc" \
        --query 'Vpcs[0].VpcId' \
        --output text \
        --region $REGION 2>/dev/null || echo "")
    
    if [ ! -z "$VPC_ID" ] && [ "$VPC_ID" != "None" ]; then
        echo "Cleaning up VPC resources..."
        
        # Delete security groups (except default)
        SG_IDS=$(aws ec2 describe-security-groups \
            --filters "Name=vpc-id,Values=$VPC_ID" \
            --query "SecurityGroups[?GroupName!='default'].GroupId" \
            --output text \
            --region $REGION 2>/dev/null || echo "")
        
        if [ ! -z "$SG_IDS" ]; then
            for sg in $SG_IDS; do
                aws ec2 delete-security-group \
                    --group-id $sg \
                    --region $REGION 2>/dev/null || echo "  Could not delete security group $sg"
            done
        fi
        
        # Delete subnets
        SUBNET_IDS=$(aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=$VPC_ID" \
            --query 'Subnets[].SubnetId' \
            --output text \
            --region $REGION 2>/dev/null || echo "")
        
        if [ ! -z "$SUBNET_IDS" ]; then
            for subnet in $SUBNET_IDS; do
                aws ec2 delete-subnet \
                    --subnet-id $subnet \
                    --region $REGION 2>/dev/null || echo "  Could not delete subnet $subnet"
            done
        fi
        
        # Detach and delete internet gateway
        IGW_ID=$(aws ec2 describe-internet-gateways \
            --filters "Name=attachment.vpc-id,Values=$VPC_ID" \
            --query 'InternetGateways[0].InternetGatewayId' \
            --output text \
            --region $REGION 2>/dev/null || echo "")
        
        if [ ! -z "$IGW_ID" ] && [ "$IGW_ID" != "None" ]; then
            aws ec2 detach-internet-gateway \
                --internet-gateway-id $IGW_ID \
                --vpc-id $VPC_ID \
                --region $REGION 2>/dev/null
            
            aws ec2 delete-internet-gateway \
                --internet-gateway-id $IGW_ID \
                --region $REGION 2>/dev/null
        fi
        
        # Delete VPC
        echo "Deleting VPC..."
        aws ec2 delete-vpc \
            --vpc-id $VPC_ID \
            --region $REGION 2>/dev/null || echo "VPC could not be deleted (may have dependencies)"
    fi
    
    echo ""
    echo -e "${GREEN}Container decommission complete!${NC}"
    echo "Monthly cost savings: ~$20-120 (depending on configuration)"
    echo "Note: MongoDB Atlas subscription should be cancelled separately if no longer needed"
}

# Function to show deployment status
show_status() {
    echo ""
    echo -e "${BOLD}RodNGun Infrastructure Status${NC}"
    echo "======================================"
    echo ""
    
    # Check Lightsail
    echo -e "${BLUE}Lightsail Status:${NC}"
    LIGHTSAIL_INSTANCE=$(aws lightsail get-instance \
        --instance-name rodngun-api \
        --region $REGION \
        --query 'instance.state.name' \
        --output text 2>/dev/null || echo "not-found")
    
    if [ "$LIGHTSAIL_INSTANCE" != "not-found" ]; then
        STATIC_IP=$(aws lightsail get-static-ip \
            --static-ip-name rodngun-api-ip \
            --region $REGION \
            --query 'staticIp.ipAddress' \
            --output text 2>/dev/null || echo "none")
        
        echo -e "  Instance: ${GREEN}$LIGHTSAIL_INSTANCE${NC}"
        echo "  Static IP: $STATIC_IP"
        echo "  Monthly Cost: ~$10-12"
    else
        echo "  Status: Not deployed"
    fi
    
    echo ""
    
    # Check App Runner
    echo -e "${BLUE}App Runner Status:${NC}"
    APP_RUNNER=$(aws apprunner list-services \
        --region $REGION \
        --query "ServiceSummaryList[?ServiceName=='rodngun-api'].[Status,ServiceUrl]" \
        --output text 2>/dev/null || echo "")
    
    if [ ! -z "$APP_RUNNER" ]; then
        STATUS=$(echo "$APP_RUNNER" | awk '{print $1}')
        URL=$(echo "$APP_RUNNER" | awk '{print $2}')
        echo -e "  Status: ${GREEN}$STATUS${NC}"
        echo "  URL: https://$URL"
        echo "  Monthly Cost: ~$20-40 + MongoDB Atlas"
    else
        echo "  Status: Not deployed"
    fi
    
    echo ""
    
    # Check ECS/Fargate
    echo -e "${BLUE}ECS/Fargate Status:${NC}"
    ECS_CLUSTER=$(aws ecs describe-clusters \
        --clusters rodngun-cluster \
        --region $REGION \
        --query 'clusters[0].status' \
        --output text 2>/dev/null || echo "")
    
    if [ ! -z "$ECS_CLUSTER" ] && [ "$ECS_CLUSTER" != "None" ]; then
        SERVICE_STATUS=$(aws ecs describe-services \
            --cluster rodngun-cluster \
            --services rodngun-api-service \
            --region $REGION \
            --query 'services[0].status' \
            --output text 2>/dev/null || echo "not-found")
        
        ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names rodngun-alb \
            --query 'LoadBalancers[0].DNSName' \
            --output text \
            --region $REGION 2>/dev/null || echo "")
        
        echo -e "  Cluster: ${GREEN}$ECS_CLUSTER${NC}"
        echo "  Service: $SERVICE_STATUS"
        if [ ! -z "$ALB_DNS" ] && [ "$ALB_DNS" != "None" ]; then
            echo "  ALB URL: http://$ALB_DNS"
        fi
        echo "  Monthly Cost: ~$35-50 + MongoDB Atlas"
    else
        echo "  Status: Not deployed"
    fi
    
    echo ""
}

# Function to analyze costs
analyze_costs() {
    echo ""
    echo -e "${BOLD}Running AWS Cost Analysis${NC}"
    echo "======================================"
    
    if [ -f "$SCRIPT_DIR/cost/analyze.sh" ]; then
        bash "$SCRIPT_DIR/cost/analyze.sh"
    elif [ -f "$SCRIPT_DIR/aws_cost_report.sh" ]; then
        bash "$SCRIPT_DIR/aws_cost_report.sh"
    else
        echo -e "${RED}ERROR: Cost analysis script not found${NC}"
        echo "Creating cost analysis script..."
        create_cost_script
        bash "$SCRIPT_DIR/cost/analyze.sh"
    fi
}

# Function to clean ALL AWS resources
clean_all_resources() {
    echo ""
    echo -e "${BOLD}${RED}⚠️  DANGER: Complete AWS Account Cleanup${NC}"
    echo "======================================"
    echo ""
    echo -e "${RED}This will attempt to DELETE ALL AWS resources in region: $REGION${NC}"
    echo ""
    echo "Resources to be removed:"
    echo "  • ALL Lightsail instances, IPs, snapshots, and keys"
    echo "  • ALL EC2 instances, volumes, snapshots, and AMIs"
    echo "  • ALL ECS clusters, services, and tasks"
    echo "  • ALL App Runner services"
    echo "  • ALL ECR repositories and images"
    echo "  • ALL RDS databases and snapshots"
    echo "  • ALL S3 buckets (if empty)"
    echo "  • ALL Lambda functions"
    echo "  • ALL VPCs (except default), subnets, and security groups"
    echo "  • ALL Load balancers and target groups"
    echo "  • ALL CloudFormation stacks"
    echo ""
    echo -e "${YELLOW}This action CANNOT be undone!${NC}"
    echo ""
    read -p "Are you ABSOLUTELY SURE? Type 'DELETE EVERYTHING' to confirm: " confirm
    
    if [ "$confirm" != "DELETE EVERYTHING" ]; then
        echo "Cleanup cancelled."
        exit 0
    fi
    
    echo ""
    echo -e "${YELLOW}Final confirmation required...${NC}"
    read -p "This will delete ALL resources and may incur data loss. Type 'yes' to proceed: " final_confirm
    
    if [ "$final_confirm" != "yes" ]; then
        echo "Cleanup cancelled."
        exit 0
    fi
    
    echo ""
    echo -e "${RED}Starting complete cleanup...${NC}"
    echo ""
    
    # Track errors
    ERRORS=0
    
    # 1. Lightsail Resources
    echo -e "${YELLOW}Cleaning Lightsail resources...${NC}"
    
    # Delete instances
    LIGHTSAIL_INSTANCES=$(aws lightsail get-instances --region $REGION --query 'instances[].name' --output text 2>/dev/null || echo "")
    if [ ! -z "$LIGHTSAIL_INSTANCES" ]; then
        for instance in $LIGHTSAIL_INSTANCES; do
            echo "  Deleting Lightsail instance: $instance"
            aws lightsail delete-instance --instance-name $instance --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # Delete static IPs
    STATIC_IPS=$(aws lightsail get-static-ips --region $REGION --query 'staticIps[].name' --output text 2>/dev/null || echo "")
    if [ ! -z "$STATIC_IPS" ]; then
        for ip in $STATIC_IPS; do
            echo "  Releasing static IP: $ip"
            aws lightsail release-static-ip --static-ip-name $ip --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # Delete snapshots
    LIGHTSAIL_SNAPSHOTS=$(aws lightsail get-instance-snapshots --region $REGION --query 'instanceSnapshots[].name' --output text 2>/dev/null || echo "")
    if [ ! -z "$LIGHTSAIL_SNAPSHOTS" ]; then
        for snapshot in $LIGHTSAIL_SNAPSHOTS; do
            echo "  Deleting snapshot: $snapshot"
            aws lightsail delete-instance-snapshot --instance-snapshot-name $snapshot --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # Delete key pairs
    LIGHTSAIL_KEYS=$(aws lightsail get-key-pairs --region $REGION --query 'keyPairs[].name' --output text 2>/dev/null || echo "")
    if [ ! -z "$LIGHTSAIL_KEYS" ]; then
        for key in $LIGHTSAIL_KEYS; do
            echo "  Deleting key pair: $key"
            aws lightsail delete-key-pair --key-pair-name $key --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # 2. EC2 Resources
    echo ""
    echo -e "${YELLOW}Cleaning EC2 resources...${NC}"
    
    # Terminate instances
    EC2_INSTANCES=$(aws ec2 describe-instances --region $REGION \
        --query 'Reservations[].Instances[?State.Name!=`terminated`].InstanceId' \
        --output text 2>/dev/null || echo "")
    if [ ! -z "$EC2_INSTANCES" ]; then
        echo "  Terminating EC2 instances: $EC2_INSTANCES"
        aws ec2 terminate-instances --instance-ids $EC2_INSTANCES --region $REGION 2>/dev/null || ((ERRORS++))
        echo "  Waiting for termination..."
        aws ec2 wait instance-terminated --instance-ids $EC2_INSTANCES --region $REGION 2>/dev/null || true
    fi
    
    # Delete volumes
    VOLUMES=$(aws ec2 describe-volumes --region $REGION \
        --query 'Volumes[?State==`available`].VolumeId' \
        --output text 2>/dev/null || echo "")
    if [ ! -z "$VOLUMES" ]; then
        for vol in $VOLUMES; do
            echo "  Deleting volume: $vol"
            aws ec2 delete-volume --volume-id $vol --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # Delete snapshots (owned by us)
    ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
    SNAPSHOTS=$(aws ec2 describe-snapshots --owner-ids $ACCOUNT_ID --region $REGION \
        --query 'Snapshots[].SnapshotId' --output text 2>/dev/null || echo "")
    if [ ! -z "$SNAPSHOTS" ]; then
        for snap in $SNAPSHOTS; do
            echo "  Deleting snapshot: $snap"
            aws ec2 delete-snapshot --snapshot-id $snap --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # Release Elastic IPs
    EIPS=$(aws ec2 describe-addresses --region $REGION --query 'Addresses[].AllocationId' --output text 2>/dev/null || echo "")
    if [ ! -z "$EIPS" ]; then
        for eip in $EIPS; do
            echo "  Releasing Elastic IP: $eip"
            aws ec2 release-address --allocation-id $eip --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # 3. Container Services
    echo ""
    echo -e "${YELLOW}Cleaning container services...${NC}"
    
    # Delete App Runner services
    APP_RUNNER_ARNS=$(aws apprunner list-services --region $REGION \
        --query 'ServiceSummaryList[].ServiceArn' --output text 2>/dev/null || echo "")
    if [ ! -z "$APP_RUNNER_ARNS" ]; then
        for arn in $APP_RUNNER_ARNS; do
            echo "  Deleting App Runner service: $arn"
            aws apprunner delete-service --service-arn $arn --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # Delete ECS services and clusters
    ECS_CLUSTERS=$(aws ecs list-clusters --region $REGION --query 'clusterArns[]' --output text 2>/dev/null || echo "")
    if [ ! -z "$ECS_CLUSTERS" ]; then
        for cluster in $ECS_CLUSTERS; do
            # Get services in cluster
            SERVICES=$(aws ecs list-services --cluster $cluster --region $REGION \
                --query 'serviceArns[]' --output text 2>/dev/null || echo "")
            if [ ! -z "$SERVICES" ]; then
                for service in $SERVICES; do
                    echo "  Scaling down ECS service: $service"
                    aws ecs update-service --cluster $cluster --service $service \
                        --desired-count 0 --region $REGION 2>/dev/null || true
                    echo "  Deleting ECS service: $service"
                    aws ecs delete-service --cluster $cluster --service $service \
                        --force --region $REGION 2>/dev/null || ((ERRORS++))
                done
            fi
            echo "  Deleting ECS cluster: $cluster"
            aws ecs delete-cluster --cluster $cluster --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # Delete ECR repositories
    ECR_REPOS=$(aws ecr describe-repositories --region $REGION \
        --query 'repositories[].repositoryName' --output text 2>/dev/null || echo "")
    if [ ! -z "$ECR_REPOS" ]; then
        for repo in $ECR_REPOS; do
            echo "  Deleting ECR repository: $repo"
            aws ecr delete-repository --repository-name $repo --force \
                --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # 4. Load Balancers
    echo ""
    echo -e "${YELLOW}Cleaning load balancers...${NC}"
    
    # Delete ALBs/NLBs
    LB_ARNS=$(aws elbv2 describe-load-balancers --region $REGION \
        --query 'LoadBalancers[].LoadBalancerArn' --output text 2>/dev/null || echo "")
    if [ ! -z "$LB_ARNS" ]; then
        for lb in $LB_ARNS; do
            echo "  Deleting load balancer: $lb"
            aws elbv2 delete-load-balancer --load-balancer-arn $lb \
                --region $REGION 2>/dev/null || ((ERRORS++))
        done
        sleep 10  # Wait for LBs to start deleting
    fi
    
    # Delete target groups
    TG_ARNS=$(aws elbv2 describe-target-groups --region $REGION \
        --query 'TargetGroups[].TargetGroupArn' --output text 2>/dev/null || echo "")
    if [ ! -z "$TG_ARNS" ]; then
        for tg in $TG_ARNS; do
            echo "  Deleting target group: $tg"
            aws elbv2 delete-target-group --target-group-arn $tg \
                --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # 5. S3 Buckets (only if empty)
    echo ""
    echo -e "${YELLOW}Cleaning S3 buckets...${NC}"
    
    S3_BUCKETS=$(aws s3api list-buckets --query 'Buckets[].Name' --output text 2>/dev/null || echo "")
    if [ ! -z "$S3_BUCKETS" ]; then
        for bucket in $S3_BUCKETS; do
            # Check if bucket is in our region
            BUCKET_REGION=$(aws s3api get-bucket-location --bucket $bucket \
                --query 'LocationConstraint' --output text 2>/dev/null || echo "")
            if [ "$BUCKET_REGION" = "$REGION" ] || [ "$BUCKET_REGION" = "None" -a "$REGION" = "us-east-1" ]; then
                # Try to empty and delete (will fail if versioning is on or bucket is not empty)
                echo "  Attempting to delete bucket: $bucket"
                aws s3 rb s3://$bucket --force 2>/dev/null || {
                    echo "    Could not delete $bucket (may contain data or have versioning)"
                    ((ERRORS++))
                }
            fi
        done
    fi
    
    # 6. Lambda Functions
    echo ""
    echo -e "${YELLOW}Cleaning Lambda functions...${NC}"
    
    LAMBDA_FUNCTIONS=$(aws lambda list-functions --region $REGION \
        --query 'Functions[].FunctionName' --output text 2>/dev/null || echo "")
    if [ ! -z "$LAMBDA_FUNCTIONS" ]; then
        for func in $LAMBDA_FUNCTIONS; do
            echo "  Deleting Lambda function: $func"
            aws lambda delete-function --function-name $func \
                --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # 7. CloudFormation Stacks
    echo ""
    echo -e "${YELLOW}Cleaning CloudFormation stacks...${NC}"
    
    CF_STACKS=$(aws cloudformation list-stacks --region $REGION \
        --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
        --query 'StackSummaries[].StackName' --output text 2>/dev/null || echo "")
    if [ ! -z "$CF_STACKS" ]; then
        for stack in $CF_STACKS; do
            echo "  Deleting CloudFormation stack: $stack"
            aws cloudformation delete-stack --stack-name $stack \
                --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # 8. VPCs (except default)
    echo ""
    echo -e "${YELLOW}Cleaning custom VPCs...${NC}"
    
    VPCS=$(aws ec2 describe-vpcs --region $REGION \
        --query 'Vpcs[?IsDefault==`false`].VpcId' --output text 2>/dev/null || echo "")
    if [ ! -z "$VPCS" ]; then
        for vpc in $VPCS; do
            echo "  Cleaning VPC: $vpc"
            
            # Delete subnets
            SUBNETS=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$vpc" \
                --region $REGION --query 'Subnets[].SubnetId' --output text 2>/dev/null || echo "")
            for subnet in $SUBNETS; do
                aws ec2 delete-subnet --subnet-id $subnet --region $REGION 2>/dev/null || true
            done
            
            # Delete route tables (except main)
            ROUTE_TABLES=$(aws ec2 describe-route-tables --filters "Name=vpc-id,Values=$vpc" \
                --region $REGION --query 'RouteTables[?Main!=`true`].RouteTableId' --output text 2>/dev/null || echo "")
            for rt in $ROUTE_TABLES; do
                aws ec2 delete-route-table --route-table-id $rt --region $REGION 2>/dev/null || true
            done
            
            # Detach and delete internet gateways
            IGW=$(aws ec2 describe-internet-gateways --filters "Name=attachment.vpc-id,Values=$vpc" \
                --region $REGION --query 'InternetGateways[0].InternetGatewayId' --output text 2>/dev/null || echo "")
            if [ ! -z "$IGW" ] && [ "$IGW" != "None" ]; then
                aws ec2 detach-internet-gateway --internet-gateway-id $IGW --vpc-id $vpc \
                    --region $REGION 2>/dev/null || true
                aws ec2 delete-internet-gateway --internet-gateway-id $IGW \
                    --region $REGION 2>/dev/null || true
            fi
            
            # Delete security groups (except default)
            SGS=$(aws ec2 describe-security-groups --filters "Name=vpc-id,Values=$vpc" \
                --region $REGION --query "SecurityGroups[?GroupName!='default'].GroupId" --output text 2>/dev/null || echo "")
            for sg in $SGS; do
                aws ec2 delete-security-group --group-id $sg --region $REGION 2>/dev/null || true
            done
            
            # Delete VPC
            aws ec2 delete-vpc --vpc-id $vpc --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # 9. RDS Resources
    echo ""
    echo -e "${YELLOW}Cleaning RDS resources...${NC}"
    
    # Delete DB instances
    DB_INSTANCES=$(aws rds describe-db-instances --region $REGION \
        --query 'DBInstances[].DBInstanceIdentifier' --output text 2>/dev/null || echo "")
    if [ ! -z "$DB_INSTANCES" ]; then
        for db in $DB_INSTANCES; do
            echo "  Deleting RDS instance: $db"
            aws rds delete-db-instance --db-instance-identifier $db \
                --skip-final-snapshot --delete-automated-backups \
                --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    # Delete DB snapshots
    DB_SNAPSHOTS=$(aws rds describe-db-snapshots --region $REGION \
        --snapshot-type manual --query 'DBSnapshots[].DBSnapshotIdentifier' \
        --output text 2>/dev/null || echo "")
    if [ ! -z "$DB_SNAPSHOTS" ]; then
        for snap in $DB_SNAPSHOTS; do
            echo "  Deleting RDS snapshot: $snap"
            aws rds delete-db-snapshot --db-snapshot-identifier $snap \
                --region $REGION 2>/dev/null || ((ERRORS++))
        done
    fi
    
    echo ""
    echo "======================================"
    if [ $ERRORS -eq 0 ]; then
        echo -e "${GREEN}Cleanup completed successfully!${NC}"
        echo "All detected resources have been removed."
    else
        echo -e "${YELLOW}Cleanup completed with $ERRORS errors.${NC}"
        echo "Some resources may not have been deleted."
        echo "Run './scripts/rodngun-cloud cost' to check remaining resources."
    fi
    echo ""
    echo "Note: Some resources may take time to fully delete."
    echo "Default VPCs and some AWS-managed resources were preserved."
}

# Function to create organized script structure
create_script_structure() {
    echo -e "${YELLOW}Creating organized script structure...${NC}"
    
    # Create directories
    mkdir -p "$SCRIPT_DIR/lightsail"
    mkdir -p "$SCRIPT_DIR/containers"
    mkdir -p "$SCRIPT_DIR/cost"
    mkdir -p "$SCRIPT_DIR/common"
    
    # Move existing scripts if they exist
    [ -f "$SCRIPT_DIR/deploy_lightsail.sh" ] && mv "$SCRIPT_DIR/deploy_lightsail.sh" "$SCRIPT_DIR/lightsail/deploy.sh"
    [ -f "$SCRIPT_DIR/deploy_apprunner.sh" ] && mv "$SCRIPT_DIR/deploy_apprunner.sh" "$SCRIPT_DIR/containers/deploy_apprunner.sh"
    [ -f "$SCRIPT_DIR/deploy_fargate.sh" ] && mv "$SCRIPT_DIR/deploy_fargate.sh" "$SCRIPT_DIR/containers/deploy_fargate.sh"
    [ -f "$SCRIPT_DIR/aws_cost_report.sh" ] && mv "$SCRIPT_DIR/aws_cost_report.sh" "$SCRIPT_DIR/cost/analyze.sh"
    
    echo -e "${GREEN}Script structure created${NC}"
}

# Function to backup MongoDB data locally
backup_data() {
    echo ""
    echo -e "${BOLD}Creating MongoDB BSON Backup${NC}"
    echo "======================================"
    echo ""
    
    # Check if backup script exists
    if [ -f "$SCRIPT_DIR/create_local_mongodb_backup.sh" ]; then
        bash "$SCRIPT_DIR/create_local_mongodb_backup.sh"
    else
        echo -e "${RED}ERROR: Backup script not found${NC}"
        echo "Expected location: $SCRIPT_DIR/create_local_mongodb_backup.sh"
        exit 1
    fi
}

# Function to deploy data to Lightsail MongoDB
deploy_data() {
    echo ""
    echo -e "${BOLD}Deploying MongoDB Data to Lightsail${NC}"
    echo "======================================"
    echo ""
    
    # Check prerequisites
    INSTANCE_NAME="rodngun-api"
    KEY_PATH="$HOME/.ssh/rodngun-lightsail-key.pem"
    PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
    REGULATION_DIR="$PROJECT_DIR/src/rodngun_ai/json"
    BOUNDARY_DIR="$PROJECT_DIR/boundary_data"
    
    # Check if instance exists
    echo -e "${YELLOW}Checking Lightsail instance...${NC}"
    INSTANCE_IP=$(aws lightsail get-instance \
        --instance-name $INSTANCE_NAME \
        --region $REGION \
        --query 'instance.publicIpAddress' \
        --output text 2>/dev/null || echo "")
    
    if [ -z "$INSTANCE_IP" ]; then
        INSTANCE_IP=$(aws lightsail get-static-ip \
            --static-ip-name "${INSTANCE_NAME}-ip" \
            --region $REGION \
            --query 'staticIp.ipAddress' \
            --output text 2>/dev/null || echo "")
    fi
    
    if [ -z "$INSTANCE_IP" ]; then
        echo -e "${RED}ERROR: Lightsail instance not found${NC}"
        echo "Please deploy Lightsail first: $0 deploy lightsail"
        exit 1
    fi
    
    echo -e "${GREEN}Instance found at: $INSTANCE_IP${NC}"
    
    # Check SSH connectivity
    echo -e "${YELLOW}Testing SSH connectivity...${NC}"
    if ! ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i "$KEY_PATH" ubuntu@$INSTANCE_IP "echo 'Connected'" 2>/dev/null; then
        echo -e "${RED}ERROR: Cannot connect via SSH${NC}"
        echo "Check SSH key at: $KEY_PATH"
        exit 1
    fi
    
    # Check if backup exists or create new one
    echo -e "${YELLOW}Looking for recent backup...${NC}"
    LATEST_BACKUP=$(ls -t "$PROJECT_DIR/backups"/mongodb_local_backup_*/rodngun_mongodb_backup.tar.gz 2>/dev/null | head -1)
    
    if [ -z "$LATEST_BACKUP" ]; then
        echo "No backup found. Creating new backup..."
        backup_data
        LATEST_BACKUP=$(ls -t "$PROJECT_DIR/backups"/mongodb_local_backup_*/rodngun_mongodb_backup.tar.gz 2>/dev/null | head -1)
    else
        echo -e "${GREEN}Found backup: $(basename $(dirname "$LATEST_BACKUP"))${NC}"
        read -p "Use this backup? (y/n) or 'c' to create new: " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Cc]$ ]]; then
            backup_data
            LATEST_BACKUP=$(ls -t "$PROJECT_DIR/backups"/mongodb_local_backup_*/rodngun_mongodb_backup.tar.gz 2>/dev/null | head -1)
        elif [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Deployment cancelled."
            exit 0
        fi
    fi
    
    # Upload and restore backup
    echo -e "${YELLOW}Uploading backup to Lightsail...${NC}"
    BACKUP_SIZE=$(du -sh "$LATEST_BACKUP" | cut -f1)
    echo "Backup size: $BACKUP_SIZE"
    
    scp -o StrictHostKeyChecking=no -i "$KEY_PATH" \
        "$LATEST_BACKUP" \
        "ubuntu@$INSTANCE_IP:/tmp/mongodb_backup.tar.gz"
    
    echo -e "${YELLOW}Restoring data on Lightsail MongoDB...${NC}"
    ssh -o StrictHostKeyChecking=no -i "$KEY_PATH" ubuntu@$INSTANCE_IP << 'ENDSSH'
        set -e
        
        # Check MongoDB status
        if ! systemctl is-active --quiet mongod; then
            echo "Starting MongoDB..."
            sudo systemctl start mongod
            sleep 3
        fi
        
        # Extract backup
        cd /tmp
        tar -xzf mongodb_backup.tar.gz
        
        # Check what's in the backup
        echo "Backup contents:"
        ls -la dump/
        
        # Restore to MongoDB
        echo "Restoring to MongoDB..."
        
        # If backup has rodngun_backup database, restore it to rodngun
        if [ -d "dump/rodngun_backup" ]; then
            mongorestore --drop --db rodngun dump/rodngun_backup/ 2>&1 | grep -E "done|imported" || true
        elif [ -d "dump/rodngun" ]; then
            mongorestore --drop --db rodngun dump/rodngun/ 2>&1 | grep -E "done|imported" || true
        else
            echo "ERROR: No rodngun database found in backup"
            ls -la dump/
            exit 1
        fi
        
        # Verify restoration
        echo ""
        echo "Verification:"
        mongo rodngun --eval '
            print("Database: rodngun");
            print("Collections:");
            db.getCollectionNames().forEach(function(c) {
                var count = db[c].countDocuments();
                print("  - " + c + ": " + count + " documents");
            });
            var stats = db.stats();
            print("Total size: " + (stats.dataSize / 1024 / 1024).toFixed(2) + " MB");
        ' --quiet
        
        # Clean up
        rm -rf /tmp/dump /tmp/mongodb_backup.tar.gz
        
        # Restart API if it's running
        if systemctl is-active --quiet rodngun-api; then
            echo "Restarting API service..."
            sudo systemctl restart rodngun-api
        fi
        
        echo ""
        echo "✅ Data deployment complete!"
ENDSSH
    
    echo ""
    echo "======================================"
    echo -e "${GREEN}✅ Data Deployed Successfully!${NC}"
    echo "======================================"
    echo ""
    echo "MongoDB on Lightsail has been updated with:"
    echo "  - Regulation data from: $REGULATION_DIR"
    echo "  - Boundary data from: $BOUNDARY_DIR"
    echo ""
    echo "API endpoint: http://$INSTANCE_IP"
    echo ""
}

# Main script logic
case "$1" in
    deploy)
        case "$2" in
            lightsail)
                deploy_lightsail
                ;;
            containers|container)
                deploy_containers
                ;;
            *)
                echo -e "${RED}ERROR: Invalid deployment type${NC}"
                show_usage
                ;;
        esac
        ;;
    decommission|destroy|teardown)
        case "$2" in
            lightsail)
                decommission_lightsail
                ;;
            containers|container)
                decommission_containers
                ;;
            *)
                echo -e "${RED}ERROR: Invalid decommission type${NC}"
                show_usage
                ;;
        esac
        ;;
    deploy-data)
        deploy_data
        ;;
    backup-data)
        backup_data
        ;;
    cost|costs)
        analyze_costs
        ;;
    status)
        show_status
        ;;
    clean|cleanup|destroy-all)
        clean_all_resources
        ;;
    help|-h|--help)
        show_usage
        ;;
    *)
        echo -e "${RED}ERROR: Invalid command${NC}"
        show_usage
        ;;
esac

exit 0